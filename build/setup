#!/usr/bin/env python
'''Move SConstruct into place and similar build setup steps'''

import os
import sys

build = os.path.realpath(os.path.abspath(os.path.dirname(__file__)))

def link(src,dst=None):
  if not dst:
    dst = os.path.basename(src)
  if not os.path.exists(dst):
    try:
      print 'ln -s %s %s'%(src,dst)
      os.symlink(src,dst)
    except os.error as e:
      print "Couldn't link %s as %s: %s" %(src,dst,e)
  elif os.path.islink(dst) and os.readlink(dst)==src:
    pass
  else:
    print "%s already exists! Please ensure that it is a symlink to %s" %(src,dst)

def move(src,dst):
  print 'mv %s %s'%(src,dst)
  os.rename(src,dst)

# Rename SConstruct.options or config.py to core/build/config.py
config = os.path.join(build,'config.py')
bad = 'SConstruct.options'
if os.path.exists(bad):
  if os.path.exists('config.py') or os.path.exists(config):
    print>>sys.stderr, 'Both %s and config.py exist.  They should be merged into %s.'%(bad,config)
    sys.exit(1)
  if os.path.islink(bad):
    print 'rm %s'%bad
    os.remove(bad)
  else:
    move(bad,config)

# Touch core/build/config.py
if not os.path.exists(config):
  print 'touch %s'%config
  open(config,'a')

# Add symlinks
link(os.path.join(build,'SConstruct'))
link(os.path.join(build,'config.py'))
link(os.path.join(build,'setup.cfg'))
link(os.path.join(build,'__init__.py'))
if os.path.exists('core') and not os.path.exists('SConscript'):
  link(os.path.join(build,'SConscript'))

# Add site_scons symlink
scons = 'gui/site_scons'
if os.path.exists(scons):
  link(scons)
